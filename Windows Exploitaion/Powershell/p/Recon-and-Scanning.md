#### 40. Recon and Scanning Part 1

###### Recon and Scanning

- Host Discovery
- Port-Scan
- Other Recon methods

###### [Nishang](https://github.com/samratashok/nishang) - PowerShell for penetration testing and offensive security

- Import ```Nishang```

```PowerShell
PS C:\Users\Administrator> cd .\Desktop\nishang-master
```

```PowerShell
PS C:\Users\Administrator\Desktop\nishang-master> Import-Module .\nishang.psm1
WARNING: The names of some imported commands from the module 'nishang' include unapproved verbs that might make them less discoverable. To find the commands with unapproved verbs, run the Import-Module
command again with the Verbose parameter. For a list of approved verbs, type Get-Verb.
WARNING: Some imported command names contain one or more of the following restricted characters: # , ( ) {{ }} [ ] & - / \ $ ^ ; : " ' < > | ? @ ` * % + = ~
PS C:\Users\Administrator\Desktop\nishang-master>
```

- List the ```commands``` exported by the module

```PowerShell
PS C:\Users\Administrator\Desktop\nishang-master> Get-Command -Module nishang

CommandType     Name                                               ModuleName
-----------     ----                                               ----------
Function        Add-Exfiltration                                   nishang
Function        Add-Persistence                                    nishang
Function        Add-RegBackdoor                                    nishang
Function        Add-ScrnSaveBackdoor                               nishang
Function        Base64ToString                                     nishang
Function        Check-VM                                           nishang
Function        ConvertTo-ROT13                                    nishang
Function        Copy-VSS                                           nishang
Function        Create-MultipleSessions                            nishang
Function        DNS_TXT_Pwnage                                     nishang
Function        Do-Exfiltration                                    nishang
Function        Download                                           nishang
Function        Download_Execute                                   nishang
Function        Download-Execute-PS                                nishang
Function        Enable-DuplicateToken                              nishang
Function        Execute-Command-MSSQL                              nishang
Function        Execute-DNSTXT-Code                                nishang
Function        Execute-OnTime                                     nishang
Function        ExetoText                                          nishang
Function        FireBuster                                         nishang
Function        FireListener                                       nishang
Function        Get-Information                                    nishang
Function        Get-LsaSecret                                      nishang
Function        Get-PassHashes                                     nishang
Function        Get-PassHints                                      nishang
Function        Get-Unconstrained                                  nishang
Function        Get-WebCredentials                                 nishang
Function        Get-Wlan-Keys                                      nishang
Function        Get-WmiShellOutput                                 nishang
Function        Gupt-Backdoor                                      nishang
Function        HTTP-Backdoor                                      nishang
Function        Invoke-ADSBackdoor                                 nishang
Function        Invoke-AmsiBypass                                  nishang
Function        Invoke-BruteForce                                  nishang
Function        Invoke-CredentialsPhish                            nishang
Function        Invoke-Decode                                      nishang
Function        Invoke-Encode                                      nishang
Function        Invoke-Interceptor                                 nishang
Function        Invoke-JSRatRegsvr                                 nishang
Function        Invoke-JSRatRundll                                 nishang
Function        Invoke-Mimikatz                                    nishang
Function        Invoke-MimikatzWDigestDowngrade                    nishang
Function        Invoke-Mimikittenz                                 nishang
Function        Invoke-NetworkRelay                                nishang
Function        Invoke-PortScan                                    nishang
Function        Invoke-PoshRatHttp                                 nishang
Function        Invoke-PoshRatHttps                                nishang
Function        Invoke-PowerShellIcmp                              nishang
Function        Invoke-PowerShellTcp                               nishang
Function        Invoke-PowerShellUdp                               nishang
Function        Invoke-PowerShellWmi                               nishang
Function        Invoke-Prasadhak                                   nishang
Function        Invoke-PSGcat                                      nishang
Function        Invoke-PsGcatAgent                                 nishang
Function        Invoke-PsUACme                                     nishang
Function        Invoke-SSIDExfil                                   nishang
Function        Out-CHM                                            nishang
Function        Out-DnsTxt                                         nishang
Function        Out-Excel                                          nishang
Function        Out-HTA                                            nishang
Function        Out-Java                                           nishang
Function        Out-JS                                             nishang
Function        Out-RundllCommand                                  nishang
Function        Out-SCF                                            nishang
Function        Out-SCT                                            nishang
Function        Out-Shortcut                                       nishang
Function        Out-WebQuery                                       nishang
Function        Out-Word                                           nishang
Function        Parse_Keys                                         nishang
Function        Remove-Persistence                                 nishang
Function        Remove-PoshRat                                     nishang
Function        Remove-Update                                      nishang
Function        Run-EXEonRemote                                    nishang
Function        Show-TargetScreen                                  nishang
Function        Speak                                              nishang
Function        Start-CaptureServer                                nishang
Function        StringtoBase64                                     nishang
Function        TexttoEXE                                          nishang

PS C:\Users\Administrator\Desktop\nishang-master>
```

- ```Port Scan```

```PowerShell
PS C:\Users\Administrator\Desktop\nishang-master> Get-Help Invoke-PortScan -Examples

NAME
    Invoke-PortScan

SYNOPSIS
    Nihsang payload which Scan IP-Addresses, Ports and HostNames

    -------------------------- EXAMPLE 1 --------------------------

    PS >Invoke-PortScan -StartAddress 192.168.0.1 -EndAddress 192.168.0.254







    -------------------------- EXAMPLE 2 --------------------------

    PS >Invoke-PortScan -StartAddress 192.168.0.1 -EndAddress 192.168.0.254 -ResolveHost







    -------------------------- EXAMPLE 3 --------------------------

    PS >Invoke-PortScan -StartAddress 192.168.0.1 -EndAddress 192.168.0.254 -ResolveHost -ScanPort


    Use above to do a port scan on default ports.




    -------------------------- EXAMPLE 4 --------------------------

    PS >Invoke-PortScan -StartAddress 192.168.0.1 -EndAddress 192.168.0.254 -ResolveHost -ScanPort -TimeOut 500







    -------------------------- EXAMPLE 5 --------------------------

    PS >Invoke-PortScan -StartAddress 192.168.0.1 -EndAddress 192.168.10.254 -ResolveHost -ScanPort -Port 80

PS C:\Users\Administrator\Desktop\nishang-master>
```

```PowerShell
PS C:\Users\Administrator\Desktop\nishang-master> Invoke-PortScan -StartAddress 10.0.0.1 -EndAddress 10.0.0.255 -ResolveHost

IPAddress                                                           HostName                                                            Ports
---------                                                           --------                                                            -----
10.0.0.1
10.0.0.95                                                           MACBOOKPRO-5ED1
10.0.0.129                                                          John-PC.pfpt.com
10.0.0.233                                                          WIN-2012-DC.pfpt.com
10.0.0.254                                                          WIN-2012-DC.pfpt.com

PS C:\Users\Administrator\Desktop\nishang-master>
```

```PowerShell
PS C:\Users\Administrator\Desktop\nishang-master> Invoke-PortScan -StartAddress 10.0.0.1 -EndAddress 10.0.0.255 -ResolveHost -ScanPort

IPAddress                                                           HostName                                                            Ports
---------                                                           --------                                                            -----
10.0.0.1                                                                                                                                {53, 80, 443}
10.0.0.95                                                           MACBOOKPRO-5ED1                                                     {}
10.0.0.129                                                          John-PC.pfpt.com                                                    {139, 445, 3389}
10.0.0.233                                                          WIN-2012-DC.pfpt.com                                                {53, 139, 389, 445...}
10.0.0.254                                                          WIN-2012-DC.pfpt.com                                                {111}

PS C:\Users\Administrator\Desktop\nishang-master>
```

###### [Posh-SecMod](https://github.com/darkoperator/Posh-SecMod) - PowerShell Module with Security cmdlets for security work

- Import ```Posh-SecMod```

```PowerShell
PS C:\Users\Administrator> cd .\Desktop
PS C:\Users\Administrator\Desktop> cd .\Posh-SecMod-master
```

```PowerShell
PS C:\Users\Administrator\Desktop\Posh-SecMod-master> Import-Module .\Posh-SecMod.psd1
```

- List the ```commands``` exported by the module

```PowerShell
PS C:\Users\Administrator\Desktop\Posh-SecMod-master> Get-Command -Module Posh-SecMod

CommandType     Name                                               ModuleName
-----------     ----                                               ----------
Function        Add-Zip                                            Posh-SecMod
Function        Compress-PostScript                                Posh-SecMod
Function        Confirm-IsAdmin                                    Posh-SecMod
Function        Connect-DBSQLite3                                  Posh-SecMod
Function        ConvertTo-InAddrARPA                               Posh-SecMod
Function        ConvertTo-PostBase64Command                        Posh-SecMod
Function        ConvertTo-PostFiletoHex                            Posh-SecMod
Function        ConvertTo-PostHextoFile                            Posh-SecMod
Function        Expand-Zip                                         Posh-SecMod
Function        Get-ApplicationHost                                Posh-SecMod
Function        Get-AuditDSComputerAccount                         Posh-SecMod
Function        Get-AuditDSDeletedAccount                          Posh-SecMod
Function        Get-AuditDSDisabledUserAcount                      Posh-SecMod
Function        Get-AuditDSLockedUserAcount                        Posh-SecMod
Function        Get-AuditDSUserAcount                              Posh-SecMod
Function        Get-AuditFileTimeStamp                             Posh-SecMod
Function        Get-AuditInstallSoftware                           Posh-SecMod
Function        Get-AuditLogedOnSessions                           Posh-SecMod
Function        Get-AuditPrefechList                               Posh-SecMod
Function        Get-AuditRegKeyLastWriteTime                       Posh-SecMod
Function        Get-ComObject                                      Posh-SecMod
Function        Get-DBSQLite3Connection                            Posh-SecMod
Function        Get-FileHash                                       Posh-SecMod
Function        Get-LogDateString                                  Posh-SecMod
Function        Get-MDNSRecords                                    Posh-SecMod
Function        Get-PoshSecModVersion                              Posh-SecMod
Function        Get-PostCopyNTDS                                   Posh-SecMod
Function        Get-PostHashdumpScript                             Posh-SecMod
Function        Get-PostReverTCPShell                              Posh-SecMod
Function        Get-RegKeys                                        Posh-SecMod
Function        Get-RegKeySecurityDescriptor                       Posh-SecMod
Function        Get-RegValue                                       Posh-SecMod
Function        Get-RegValues                                      Posh-SecMod
Function        Get-SystemDNSServer                                Posh-SecMod
Function        Get-Webconfig                                      Posh-SecMod
Function        Get-WebFile                                        Posh-SecMod
Function        Get-Whois                                          Posh-SecMod
Function        Get-Zip                                            Posh-SecMod
Function        Get-ZipChildItems_Recurse                          Posh-SecMod
Function        Import-DNSReconXML                                 Posh-SecMod
Function        Import-NmapXML                                     Posh-SecMod
Function        Invoke-ARPScan                                     Posh-SecMod
Function        Invoke-DBSQLite3Query                              Posh-SecMod
Function        Invoke-EnumSRVRecords                              Posh-SecMod
Function        Invoke-PingScan                                    Posh-SecMod
Function        Invoke-PortScan                                    Posh-SecMod
Function        Invoke-ReverseDNSLookup                            Posh-SecMod
Function        New-DBSQLConnectionString                          Posh-SecMod
Function        New-IPRange                                        Posh-SecMod
Function        New-IPv4Range                                      Posh-SecMod
Function        New-IPv4RangeFromCIDR                              Posh-SecMod
Function        New-PostDownloadExecutePE                          Posh-SecMod
Function        New-PostDownloadExecuteScript                      Posh-SecMod
Function        New-RegKey                                         Posh-SecMod
Function        New-Zip                                            Posh-SecMod
Function        Remove-DBSQLite3Connection                         Posh-SecMod
Function        Remove-RegKey                                      Posh-SecMod
Function        Remove-RegValue                                    Posh-SecMod
Function        Resolve-DNSRecord                                  Posh-SecMod
Function        Resolve-HostRecord                                 Posh-SecMod
Function        Set-RegValue                                       Posh-SecMod
Function        Start-PostRemoteProcess                            Posh-SecMod
Function        Test-RegKeyAccess                                  Posh-SecMod
Function        Update-SysinternalsTools                           Posh-SecMod

PS C:\Users\Administrator\Desktop\Posh-SecMod-master>
```

- Host Discovery - ```ARP Scan```

```PowerShell
PS C:\Users\Administrator\Desktop\Posh-SecMod-master> Get-Help Invoke-ARPScan -Examples

NAME
    Invoke-ARPScan

SYNOPSIS
    Performs an ARP scan against a given range of IPv4 IP Addresses.

    -------------------------- EXAMPLE 1 --------------------------

    C:\PS>Invoke an ARP Scan against a range of IPs specified in CIDR Format


    PS C:\> Invoke-ARPScan -CIDR 172.20.10.1/24

     MAC                                                       Address
     ---                                                       -------
     14:10:9F:D5:1A:BF                                         172.20.10.2
     00:0C:29:93:10:B5                                         172.20.10.3
     00:0C:29:93:10:B5                                         172.20.10.15

PS C:\Users\Administrator\Desktop\Posh-SecMod-master>
```

```PowerShell
PS C:\Users\Administrator\Desktop\Posh-SecMod-master> Invoke-ARPScan -CIDR 10.0.0.1/24

MAC                                                                                                   Address
---                                                                                                   -------
BC:9F:EF:69:35:19                                                                                     10.0.0.19
40:F0:2F:57:6C:13                                                                                     10.0.0.53
00:9A:CD:C9:77:54                                                                                     10.0.0.61
08:00:27:CA:01:8E                                                                                     10.0.0.94
F4:0F:24:33:5E:D1                                                                                     10.0.0.95
C8:21:58:31:F6:73                                                                                     10.0.0.173
08:00:27:7C:C3:C9                                                                                     10.0.0.233
E4:A7:A0:09:3A:12                                                                                     10.0.0.234
00:05:04:03:02:01                                                                                     10.0.0.254

PS C:\Users\Administrator\Desktop\Posh-SecMod-master>
```

- Enumerate ```DNS SRV Records```

```PowerShell
PS C:\Users\Administrator\Desktop\Posh-SecMod-master> Get-Help Invoke-EnumSRVRecords -Examples

NAME
    Invoke-EnumSRVRecords

SYNOPSIS
    Enumerates common DNS SRV Records for a given domain.

    -------------------------- EXAMPLE 1 --------------------------

    PS C:\>Invoke-EnumSRVRecords -Domain microsoft.com


    Type     : SRV
     Name     : _sip._tls.microsoft.com
     Port     : 443
     Priority : 0
     Target   : sip.microsoft.com.
     Address   : @{Name=sip.microsoft.com; Type=A; Address=65.55.30.130}

     Type     : SRV
     Name     : _sipfederationtls._tcp.microsoft.com
     Port     : 5061
     Priority : 0
     Target   : sipfed.microsoft.com.
     Address   : @{Name=sipfed.microsoft.com; Type=A; Address=65.55.30.130}

     Type     : SRV
     Name     : _xmpp-server._tcp.microsoft.com
     Port     : 5269
     Priority : 0
     Target   : sipdog3.microsoft.com.
     Address   : @{Name=sipdog3.microsoft.com; Type=A; Address=131.107.1.47}

PS C:\Users\Administrator\Desktop\Posh-SecMod-master>
```

```PowerShell
PS C:\Users\Administrator\Desktop\Posh-SecMod-master> Invoke-EnumSRVRecords -Domain google.com

Type     : SRV
Name     : _ldap._tcp.google.com
Port     : 389
Priority : 0
Target   : ldap.google.com.
Address  : @{Name=ldap.google.com; Type=A; Address=216.239.32.58}

Type     : SRV
Name     : _jabber._tcp.google.com
Port     : 5269
Priority : 0
Target   : alt2.xmpp-server.l.google.com.
Address  : @{Name=alt2.xmpp-server.l.google.com; Type=A; Address=173.194.219.125}

Type     : SRV
Name     : _jabber._tcp.google.com
Port     : 5269
Priority : 0
Target   : alt1.xmpp-server.l.google.com.
Address  : @{Name=alt1.xmpp-server.l.google.com; Type=A; Address=64.233.181.125}

Type     : SRV
Name     : _jabber._tcp.google.com
Port     : 5269
Priority : 0
Target   : alt3.xmpp-server.l.google.com.
Address  : @{Name=alt3.xmpp-server.l.google.com; Type=A; Address=74.125.192.125}

Type     : SRV
Name     : _jabber._tcp.google.com
Port     : 5269
Priority : 0
Target   : alt4.xmpp-server.l.google.com.
Address  : @{Name=alt4.xmpp-server.l.google.com; Type=A; Address=173.194.214.125}

Type     : SRV
Name     : _jabber._tcp.google.com
Port     : 5269
Priority : 0
Target   : xmpp-server.l.google.com.
Address  : @{Name=xmpp-server.l.google.com; Type=A; Address=74.125.135.125}

Type     : SRV
Name     : _xmpp-server._tcp.google.com
Port     : 5269
Priority : 0
Target   : xmpp-server.l.google.com.
Address  : @{Name=xmpp-server.l.google.com; Type=A; Address=74.125.135.125}

Type     : SRV
Name     : _xmpp-server._tcp.google.com
Port     : 5269
Priority : 0
Target   : alt2.xmpp-server.l.google.com.
Address  : @{Name=alt2.xmpp-server.l.google.com; Type=A; Address=173.194.219.125}

Type     : SRV
Name     : _xmpp-server._tcp.google.com
Port     : 5269
Priority : 0
Target   : alt4.xmpp-server.l.google.com.
Address  : @{Name=alt4.xmpp-server.l.google.com; Type=A; Address=173.194.214.125}

Type     : SRV
Name     : _xmpp-server._tcp.google.com
Port     : 5269
Priority : 0
Target   : alt3.xmpp-server.l.google.com.
Address  : @{Name=alt3.xmpp-server.l.google.com; Type=A; Address=74.125.192.125}

Type     : SRV
Name     : _xmpp-server._tcp.google.com
Port     : 5269
Priority : 0
Target   : alt1.xmpp-server.l.google.com.
Address  : @{Name=alt1.xmpp-server.l.google.com; Type=A; Address=64.233.181.125}

Type     : SRV
Name     : _xmpp-client._tcp.google.com
Port     : 5222
Priority : 0
Target   : alt1.xmpp.l.google.com.
Address  : {@{Name=alt1.xmpp.l.google.com; Type=A; Address=64.233.181.125}, @{Name=alt1.xmpp.l.google.com; Type=AAAA; Address=2607:f8b0:4001:c09::7d}}

Type     : SRV
Name     : _xmpp-client._tcp.google.com
Port     : 5222
Priority : 0
Target   : xmpp.l.google.com.
Address  : {@{Name=xmpp.l.google.com; Type=A; Address=74.125.135.125}, @{Name=xmpp.l.google.com; Type=AAAA; Address=2607:f8b0:400e:c01::7d}}

Type     : SRV
Name     : _xmpp-client._tcp.google.com
Port     : 5222
Priority : 0
Target   : alt3.xmpp.l.google.com.
Address  : {@{Name=alt3.xmpp.l.google.com; Type=A; Address=74.125.192.125}, @{Name=alt3.xmpp.l.google.com; Type=AAAA; Address=2607:f8b0:400d:c00::7d}}

Type     : SRV
Name     : _xmpp-client._tcp.google.com
Port     : 5222
Priority : 0
Target   : alt4.xmpp.l.google.com.
Address  : {@{Name=alt4.xmpp.l.google.com; Type=A; Address=173.194.214.125}, @{Name=alt4.xmpp.l.google.com; Type=AAAA; Address=2607:f8b0:400c:c0b::7d}}

Type     : SRV
Name     : _xmpp-client._tcp.google.com
Port     : 5222
Priority : 0
Target   : alt2.xmpp.l.google.com.
Address  : {@{Name=alt2.xmpp.l.google.com; Type=A; Address=173.194.219.125}, @{Name=alt2.xmpp.l.google.com; Type=AAAA; Address=2607:f8b0:4002:c03::7d}}

Type     : SRV
Name     : _jabber-client._tcp.google.com
Port     : 5222
Priority : 0
Target   : xmpp.l.google.com.
Address  : {@{Name=xmpp.l.google.com; Type=A; Address=74.125.135.125}, @{Name=xmpp.l.google.com; Type=AAAA; Address=2607:f8b0:400e:c01::7d}}

Type     : SRV
Name     : _jabber-client._tcp.google.com
Port     : 5222
Priority : 0
Target   : alt1.xmpp.l.google.com.
Address  : {@{Name=alt1.xmpp.l.google.com; Type=A; Address=64.233.181.125}, @{Name=alt1.xmpp.l.google.com; Type=AAAA; Address=2607:f8b0:4001:c09::7d}}

Type     : SRV
Name     : _jabber-client._tcp.google.com
Port     : 5222
Priority : 0
Target   : alt4.xmpp.l.google.com.
Address  : {@{Name=alt4.xmpp.l.google.com; Type=A; Address=173.194.214.125}, @{Name=alt4.xmpp.l.google.com; Type=AAAA; Address=2607:f8b0:400c:c0b::7d}}

Type     : SRV
Name     : _jabber-client._tcp.google.com
Port     : 5222
Priority : 0
Target   : alt2.xmpp.l.google.com.
Address  : {@{Name=alt2.xmpp.l.google.com; Type=A; Address=173.194.219.125}, @{Name=alt2.xmpp.l.google.com; Type=AAAA; Address=2607:f8b0:4002:c03::7d}}

Type     : SRV
Name     : _jabber-client._tcp.google.com
Port     : 5222
Priority : 0
Target   : alt3.xmpp.l.google.com.
Address  : {@{Name=alt3.xmpp.l.google.com; Type=A; Address=74.125.192.125}, @{Name=alt3.xmpp.l.google.com; Type=AAAA; Address=2607:f8b0:400d:c00::7d}}

PS C:\Users\Administrator\Desktop\Posh-SecMod-master>
```

###### [PowerSploit](https://github.com/PowerShellMafia/PowerSploit) - A PowerShell Post-Exploitation Framework

- Import ```PowerSploit```

```PowerShell
PS C:\Users\Administrator> cd .\Desktop\PowerSploit-master
```

```PowerShell
PS C:\Users\Administrator\Desktop\PowerSploit-master> Import-Module .\PowerSploit.psd1
```

- List the ```commands``` exported by the module

```PowerShell
PS C:\Users\Administrator\Desktop\PowerSploit-master> Get-Command -Module PowerSploit

CommandType     Name                                               ModuleName
-----------     ----                                               ----------
Function        Add-NetUser                                        PowerSploit
Function        Add-ObjectAcl                                      PowerSploit
Function        Add-Persistence                                    PowerSploit
Function        Add-ServiceDacl                                    PowerSploit
Function        Find-AVSignature                                   PowerSploit
Function        Find-ComputerField                                 PowerSploit
Function        Find-ForeignGroup                                  PowerSploit
Function        Find-ForeignUser                                   PowerSploit
Function        Find-GPOComputerAdmin                              PowerSploit
Function        Find-GPOLocation                                   PowerSploit
Function        Find-InterestingFile                               PowerSploit
Function        Find-LocalAdminAccess                              PowerSploit
Function        Find-ManagedSecurityGroups                         PowerSploit
Function        Find-PathDLLHijack                                 PowerSploit
Function        Find-ProcessDLLHijack                              PowerSploit
Function        Get-ADObject                                       PowerSploit
Function        Get-ApplicationHost                                PowerSploit
Function        Get-ComputerDetails                                PowerSploit
Function        Get-ComputerProperty                               PowerSploit
Function        Get-CurrentUserTokenGroupSid                       PowerSploit
Function        Get-DFSshare                                       PowerSploit
Function        Get-DomainPolicy                                   PowerSploit
Function        Get-ExploitableSystem                              PowerSploit
Function        Get-GPPPassword                                    PowerSploit
Function        Get-HttpStatus                                     PowerSploit
Function        Get-Keystrokes                                     PowerSploit
Function        Get-ModifiablePath                                 PowerSploit
Function        Get-ModifiableRegistryAutoRun                      PowerSploit
Function        Get-ModifiableScheduledTaskFile                    PowerSploit
Function        Get-ModifiableService                              PowerSploit
Function        Get-ModifiableServiceFile                          PowerSploit
Function        Get-NetComputer                                    PowerSploit
Function        Get-NetDomainTrust                                 PowerSploit
Function        Get-NetFileServer                                  PowerSploit
Function        Get-NetForestTrust                                 PowerSploit
Function        Get-NetGPO                                         PowerSploit
Function        Get-NetGPOGroup                                    PowerSploit
Function        Get-NetGroup                                       PowerSploit
Function        Get-NetGroupMember                                 PowerSploit
Function        Get-NetLocalGroup                                  PowerSploit
Function        Get-NetOU                                          PowerSploit
Function        Get-NetSite                                        PowerSploit
Function        Get-NetSubnet                                      PowerSploit
Function        Get-NetUser                                        PowerSploit
Function        Get-ObjectAcl                                      PowerSploit
Function        Get-PathAcl                                        PowerSploit
Function        Get-RegistryAlwaysInstallElevated                  PowerSploit
Function        Get-RegistryAutoLogon                              PowerSploit
Function        Get-SecurityPackages                               PowerSploit
Function        Get-ServiceDetail                                  PowerSploit
Function        Get-ServiceUnquoted                                PowerSploit
Function        Get-SiteListPassword                               PowerSploit
Function        Get-System                                         PowerSploit
Function        Get-TimedScreenshot                                PowerSploit
Function        Get-UnattendedInstallFile                          PowerSploit
Function        Get-UserProperty                                   PowerSploit
Function        Get-VaultCredential                                PowerSploit
Function        Get-VolumeShadowCopy                               PowerSploit
Function        Get-WebConfig                                      PowerSploit
Function        Install-ServiceBinary                              PowerSploit
Function        Install-SSP                                        PowerSploit
Function        Invoke-ACLScanner                                  PowerSploit
Function        Invoke-AllChecks                                   PowerSploit
Function        Invoke-CredentialInjection                         PowerSploit
Function        Invoke-DllInjection                                PowerSploit
Function        Invoke-EnumerateLocalAdmin                         PowerSploit
Function        Invoke-EventHunter                                 PowerSploit
Function        Invoke-FileFinder                                  PowerSploit
Function        Invoke-MapDomainTrust                              PowerSploit
Function        Invoke-Mimikatz                                    PowerSploit
Function        Invoke-NinjaCopy                                   PowerSploit
Function        Invoke-Portscan                                    PowerSploit
Function        Invoke-ProcessHunter                               PowerSploit
Function        Invoke-ReflectivePEInjection                       PowerSploit
Function        Invoke-ReverseDnsLookup                            PowerSploit
Function        Invoke-ServiceAbuse                                PowerSploit
Function        Invoke-ShareFinder                                 PowerSploit
Function        Invoke-Shellcode                                   PowerSploit
Function        Invoke-TokenManipulation                           PowerSploit
Function        Invoke-UserHunter                                  PowerSploit
Function        Invoke-WmiCommand                                  PowerSploit
Function        Mount-VolumeShadowCopy                             PowerSploit
Function        New-ElevatedPersistenceOption                      PowerSploit
Function        New-UserPersistenceOption                          PowerSploit
Function        New-VolumeShadowCopy                               PowerSploit
Function        Out-CompressedDll                                  PowerSploit
Function        Out-EncodedCommand                                 PowerSploit
Function        Out-EncryptedScript                                PowerSploit
Function        Out-Minidump                                       PowerSploit
Function        Remove-Comments                                    PowerSploit
Function        Remove-VolumeShadowCopy                            PowerSploit
Function        Restore-ServiceBinary                              PowerSploit
Function        Set-ADObject                                       PowerSploit
Function        Set-CriticalProcess                                PowerSploit
Function        Set-MasterBootRecord                               PowerSploit
Function        Set-ServiceBinPath                                 PowerSploit
Function        Test-ServiceDaclPermission                         PowerSploit
Function        Write-HijackDll                                    PowerSploit
Function        Write-ServiceBinary                                PowerSploit
Function        Write-UserAddMSI                                   PowerSploit
Filter          Convert-NameToSid                                  PowerSploit
Filter          Convert-SidToName                                  PowerSploit
Filter          Find-UserField                                     PowerSploit
Filter          Get-CachedRDPConnection                            PowerSploit
Filter          Get-LastLoggedOn                                   PowerSploit
Filter          Get-NetDomain                                      PowerSploit
Filter          Get-NetDomainController                            PowerSploit
Filter          Get-NetForest                                      PowerSploit
Filter          Get-NetForestCatalog                               PowerSploit
Filter          Get-NetForestDomain                                PowerSploit
Filter          Get-NetLoggedon                                    PowerSploit
Filter          Get-NetProcess                                     PowerSploit
Filter          Get-NetRDPSession                                  PowerSploit
Filter          Get-NetSession                                     PowerSploit
Filter          Get-NetShare                                       PowerSploit
Filter          Get-Proxy                                          PowerSploit
Filter          Get-UserEvent                                      PowerSploit
Filter          Invoke-CheckLocalAdminAccess                       PowerSploit

PS C:\Users\Administrator\Desktop\PowerSploit-master>
```

- ```Port Scan```

```PowerShell
PS C:\Users\Administrator\Desktop\PowerSploit-master> Get-Help Invoke-Portscan -Examples

NAME
    Invoke-Portscan

SYNOPSIS
    Simple portscan module

    PowerSploit Function: Invoke-Portscan
    Author: Rich Lundeen (http://webstersProdigy.net)
    License: BSD 3-Clause
    Required Dependencies: None
    Optional Dependencies: None

    -------------------------- EXAMPLE 1 --------------------------

    C:\PS>Invoke-Portscan -Hosts "webstersprodigy.net,google.com,microsoft.com" -TopPorts 50


    Description
    -----------
    Scans the top 50 ports for hosts found for webstersprodigy.net,google.com, and microsoft.com




    -------------------------- EXAMPLE 2 --------------------------

    C:\PS>echo webstersprodigy.net | Invoke-Portscan -oG test.gnmap -f -ports "80,443,8080"


    Description
    -----------
    Does a portscan of "webstersprodigy.net", and writes a greppable output file




    -------------------------- EXAMPLE 3 --------------------------

    C:\PS>Invoke-Portscan -Hosts 192.168.1.1/24 -T 4 -TopPorts 25 -oA localnet


    Description
    -----------
    Scans the top 20 ports for hosts found in the 192.168.1.1/24 range, outputs all file formats

PS C:\Users\Administrator\Desktop\PowerSploit-master>
```

```PowerShell
PS C:\Users\Administrator\Desktop\PowerSploit-master> Invoke-Portscan -Hosts "google.com"

Hostname      : google.com
alive         : True
openPorts     : {80, 443}
closedPorts   : {}
filteredPorts : {79, 88, 2049, 8081...}
finishTime    : 7/9/2017 6:05:12 PM

PS C:\Users\Administrator\Desktop\PowerSploit-master>
```

```PowerShell
PS C:\Users\Administrator\Desktop\PowerSploit-master> $result = Invoke-Portscan -Hosts "google.com"
```

```PowerShell
PS C:\Users\Administrator\Desktop\PowerSploit-master> $result | Select-Object -ExpandProperty FilteredPorts
5900
993
995
111
1723
22
8080
3306
135
53
143
139
445
110
3389
21
23
32768
8000
8443
2000
1026
179
6001
81
113
548
1720
1025
79
88
2049
8081
49153
631
5631
5000
646
5666
1027
49154
8008
515
2001
49152
1433
26
554
PS C:\Users\Administrator\Desktop\PowerSploit-master>
```

#### 41. Recon and Scanning Part 2

###### [Posh-Shodan](https://github.com/darkoperator/Posh-Shodan)

- Import [```Posh-Shodan```](http://www.powershellmagazine.com/2014/07/15/posh-shodan-module-for-the-shodan-service/)

```PowerShell
PS C:\Users\Administrator> cd .\Desktop\Posh-Shodan-master
```

```PowerShell
PS C:\Users\Administrator\Desktop\Posh-Shodan-master> Import-Module .\Posh-Shodan.psd1
```

- List the ```commands``` exported by the module

```PowerShell
PS C:\Users\Administrator\Desktop\Posh-Shodan-master> Get-Command -Module Posh-Shodan

CommandType     Name                                               ModuleName
-----------     ----                                               ----------
Function        Get-ShodanAPIInfo                                  Posh-Shodan
Function        Get-ShodanDNSResolve                               Posh-Shodan
Function        Get-ShodanDNSReverse                               Posh-Shodan
Function        Get-ShodanHostService                              Posh-Shodan
Function        Get-ShodanMyIP                                     Posh-Shodan
Function        Get-ShodanService                                  Posh-Shodan
Function        Measure-ShodanExploit                              Posh-Shodan
Function        Measure-ShodanHost                                 Posh-Shodan
Function        Read-ShodanAPIKey                                  Posh-Shodan
Function        Search-ShodanExploit                               Posh-Shodan
Function        Search-ShodanHost                                  Posh-Shodan
Function        Set-ShodanAPIKey                                   Posh-Shodan

PS C:\Users\Administrator\Desktop\Posh-Shodan-master>
```

- List ```help``` topics for ```Shodan```

```PowerShell
PS C:\Users\Administrator\Desktop\Posh-Shodan-master> help *shodan*

Name                              Category  Module                    Synopsis
----                              --------  ------                    --------
Get-ShodanAPIInfo                 Function  Posh-Shodan               Get features and information for a given API Key.
Get-ShodanDNSResolve              Function  Posh-Shodan               Look up the IP address for the provided list of hostnames.
Get-ShodanDNSReverse              Function  Posh-Shodan               Look up the hostnames that have been defined for the given list of IP addresses.
Get-ShodanHostService             Function  Posh-Shodan
Get-ShodanMyIP                    Function  Posh-Shodan               Get your current IP address as seen from the Internet.
Get-ShodanService                 Function  Posh-Shodan
Measure-ShodanExploit             Function  Posh-Shodan               Search across a variety of data sources for exploits and get summary information using Shodan.
Measure-ShodanHost                Function  Posh-Shodan               Returns the total number of results that matched the query and any facet information that was requested.
Read-ShodanAPIKey                 Function  Posh-Shodan               Read from disk the saved Shodan API Key
Search-ShodanExploit              Function  Posh-Shodan               Search across a variety of data sources for exploits. using Shodan
Search-ShodanHost                 Function  Posh-Shodan               Search Shodan using the same query syntax as the website and use facets to get summary information for different properties.
Set-ShodanAPIKey                  Function  Posh-Shodan               Set a default Shodan API key for use by Posh-Shodan module.
about_Shodan_Host_Search_Facets   HelpFile                            Describes the search facets that can be used when performing a search for
about_Shodan_Host_Search_Filters  HelpFile                            Describes the search filters that can be used when performing a search for

PS C:\Users\Administrator\Desktop\Posh-Shodan-master>
```

- Set the [```Shodan API Key```](https://account.shodan.io/)

```PowerShell
PS C:\Users\Administrator\Desktop\Posh-Shodan-master> Set-ShodanAPIKey -APIKey Y2DmqAThPzLFP1b1Ubanif3YGaqsoQlx

cmdlet Set-ShodanAPIKey at command pipeline position 1
Supply values for the following parameters:
MasterPassword: ****
PS C:\Users\Administrator\Desktop\Posh-Shodan-master>
```

```PowerShell
PS C:\Users\Administrator\Desktop\Posh-Shodan-master> Read-ShodanAPIKey

cmdlet Read-ShodanAPIKey at command pipeline position 1
Supply values for the following parameters:
MasterPassword: ****
PS C:\Users\Administrator\Desktop\Posh-Shodan-master>
```

- ```Shodan API Info```

```PowerShell
PS C:\Users\Administrator\Desktop\Posh-Shodan-master> Get-ShodanAPIInfo

Unlocked_Left : 0
Telnet        : False
Plan          : oss
HTTPS         : False
Unlocked      : False

PS C:\Users\Administrator\Desktop\Posh-Shodan-master>
```

- ```Shodan DNS Resolution```

```PowerShell
PS C:\Users\Administrator\Desktop\Posh-Shodan-master> Get-ShodanDNSResolve -Hostname google.com

google.com
----------
216.58.194.174

PS C:\Users\Administrator\Desktop\Posh-Shodan-master>
```

- ```Measure all Shodan Hosts```

```PowerShell
PS C:\Users\Administrator\Desktop\Posh-Shodan-master> Measure-ShodanHost -Query "default password"

Total  : 80630
Facets :

PS C:\Users\Administrator\Desktop\Posh-Shodan-master>
```

```PowerShell
PS C:\Users\Administrator\Desktop\Posh-Shodan-master> Measure-ShodanHost -Query "RDP"

Total  : 947
Facets :

PS C:\Users\Administrator\Desktop\Posh-Shodan-master>
```

```PowerShell
PS C:\Users\Administrator\Desktop\Posh-Shodan-master> Measure-ShodanHost -Query "phpmyadmin"

Total  : 36173
Facets :

PS C:\Users\Administrator\Desktop\Posh-Shodan-master>
```

- List all ```Shodan services```

```PowerShell
PS C:\Users\Administrator\Desktop\Posh-Shodan-master> Get-ShodanService

623   : IPMI
626   : serialnumbered
5985  : WinRM 2.0
2455  : Codesys
5560  : Oracle HTTP
8098  : Riak Web Interface
9000  : NAS Web Interfaces
7071  : Zimbra HTTP
62078 : iPhone
137   : NetBIOS
3000  : ntop
67    : DHCP
8090  : Insteon Hub
2087  : WHM + SSL
9151  : Tor control port
1900  : UPnP
9200  : ElasticSearch
2323  : Telnet (2323)
25    : SMTP
3128  : Squid Proxy
5353  : mDNS
21    : FTP
22    : SSH
23    : Telnet
44818 : EtherNetIP
10000 : Webmin
4949  : Munin
3790  : Metasploit
3388  : RDP (3388)
8139  : Puppet Agent
2404  : IEC-104
1723  : PPTP
2152  : GPRS Tunneling Protocol
8089  : Splunk
502   : Modbus
5986  : WinRM 2.0 + SSL
500   : IKE
995   : POP3 + SSL
631   : CUPS
5060  : SIP
993   : IMAP + SSL
992   : Telnet + SSL
465   : SMTP + SSL
8140  : Puppet Master
2628  : Dictionary
18245 : General Electric SRTP
2123  : GPRS Tunneling Protocol
32764 : Router backdoor
8333  : Bitcoin
123   : NTP
20000 : DNP3
1911  : Tridium Fox
129   : Password generator protocol
161   : SNMP
9981  : HTS/ tvheadend
11    : Systat
9999  : Telnet (Lantronix)
13    : Daytime
15    : Netstat
1023  : Telnet (1023)
17    : Quote of the day
20547 : ProConOS
19    : Character Generator
5222  : XMPP
4443  : Symantec Data Center Security
16010 : Hbase
8181  : HTTP (8181)
53    : DNS
6666  : Voldemort
5901  : VNC (5901)
9944  : Pipeline Pilot
4022  : Udpxy
28017 : MongoDB Web Interface
2067  : DLSW
64738 : Mumble server
5007  : Mitsubishi MELSEC-Q
10001 : Automated Tank Gauge
9600  : OMRON FINS
2086  : WHM
7657  : HTTP (7657)
4369  : Erlang Port Mapper Daemon
1200  : Codesys
9100  : Printer Job Language
1604  : Citrix
9051  : Tor control port
3306  : MySQL
88    : Kerberos
111   : Portmap
110   : POP3
25565 : Minecraft
8443  : HTTPS (8443)
82    : HTTP (82)
83    : HTTP (83)
80    : HTTP
81    : HTTP (81)
119   : NNTP
84    : HTTP (84)
5006  : Mitsubishi MELSEC-Q
3386  : GPRS Tunneling Protocol
8888  : AndroMouse
4040  : Chef
9943  : Pipeline Pilot + SSL
9160  : Cassandra
8069  : OpenERP
5094  : HART-IP
3479  : 2-Wire RPC
1962  : PCWorx
3389  : RDP
7777  : Oracle
5432  : PostgreSQL
18246 : General Electric SRTP
7     : Echo
523   : IBM DB2
50100 : Telnet
49152 : Supermicro Web Interface
1234  : Udpxy
3780  : Nexpose
5001  : Synology
5000  : Synology
771   : RealPort
143   : IMAP
443   : HTTPS
55553 : Metasploit (55553)
5008  : NetMobility
5357  : Microsoft-HTTPAPI/2.0
55554 : Metasploit (55554)
445   : SMB
11211 : MemCache
4500  : IKE-NAT-T
8129  : Snapstream
8834  : Nessus
102   : Siemens S7
389   : LDAP
8000  : Qconn
79    : Finger
47808 : BACnet
1434  : MS-SQL Monitor
8087  : Riak Protobuf
8080  : HTTP (8080)
6000  : X Windows
2082  : cPanel
2083  : cPanel + SSL
27017 : MongoDB
6001  : X Windows (6001)
37    : rdate
789   : Red Lion
5632  : PC Anywhere
4911  : Tridium Fox + SSL
6379  : Redis
1471  : Hak5 Pineapple
2375  : Docker
2376  : Docker + SSL
515   : Line Printer Daemon
5900  : VNC
10243 : Microsoft-HTTPAPI/2.0
7547  : Modem Web Interface

PS C:\Users\Administrator\Desktop\Posh-Shodan-master>
```

###### [PowerSploit](https://github.com/PowerShellMafia/PowerSploit)

- Import ```PowerSploit```

```PowerShell
PS C:\Users\Administrator> cd .\Desktop\PowerSploit-master
```

```PowerShell
PS C:\Users\Administrator\Desktop\PowerSploit-master> Import-Module .\PowerSploit.psd1
```

- File and Directory enumeration on web servers.
(```Get-HttpStatus```)

```PowerShell
PS C:\Users\Administrator\Desktop\PowerSploit-master> Get-Help Get-HttpStatus

NAME
    Get-HttpStatus

SYNOPSIS
    Returns the HTTP Status Codes and full URL for specified paths.

    PowerSploit Function: Get-HttpStatus
    Author: Chris Campbell (@obscuresec)
    License: BSD 3-Clause
    Required Dependencies: None
    Optional Dependencies: None


SYNTAX
    Get-HttpStatus [-Target] <String> [[-Path] <String>] [[-Port] <Int32>] [-UseSSL] [<CommonParameters>]


DESCRIPTION
    A script to check for the existence of a path or file on a webserver.


RELATED LINKS
    http://obscuresecurity.blogspot.com
    http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html

REMARKS
    To see the examples, type: "get-help Get-HttpStatus -examples".
    For more information, type: "get-help Get-HttpStatus -detailed".
    For technical information, type: "get-help Get-HttpStatus -full".
    For online help, type: "get-help Get-HttpStatus -online"

PS C:\Users\Administrator\Desktop\PowerSploit-master>
```

```PowerShell
PS C:\Users\Administrator\Desktop\PowerSploit-master> Get-Help Get-HttpStatus -Examples

NAME
    Get-HttpStatus

SYNOPSIS
    Returns the HTTP Status Codes and full URL for specified paths.

    PowerSploit Function: Get-HttpStatus
    Author: Chris Campbell (@obscuresec)
    License: BSD 3-Clause
    Required Dependencies: None
    Optional Dependencies: None

    -------------------------- EXAMPLE 1 --------------------------

    C:\PS>Get-HttpStatus -Target www.example.com -Path c:\dictionary.txt | Select-Object {where StatusCode -eq 20*}



    -------------------------- EXAMPLE 2 --------------------------

    C:\PS>Get-HttpStatus -Target www.example.com -Path c:\dictionary.txt -UseSSL


PS C:\Users\Administrator\Desktop\PowerSploit-master>
```

```PowerShell
PS C:\Users\Administrator\Desktop\PowerSploit-master> Get-HttpStatus -Target www.commercefun.com -Path .\Recon\Dictionaries\generic.txt -Port 80 | Where-Object {$_.Status -match "ok"}

                                                                                               Status URL
                                                                                               ------ ---
                                                                                                   OK http://www.commercefun.com/../
                                                                                                   OK http://www.commercefun.com/0/
```

###### Exercise

- Write a script which could save ```home/default``` page for a list of web servers.

```Get-DefaultPage.ps1```

```PowerShell
$reader = [System.IO.File]::OpenText("C:\Users\Administrator\Desktop\Code\41\ip.txt")

while($null -ne ($line = $reader.ReadLine())) {
    $filename = [System.IO.Path]::GetFileName($line)
    Invoke-WebRequest $line -OutFile $filename
}
```

- Try ```Get-HttpStatus``` on multiple machines.

```PowerShell
PS C:\Users\Administrator\Desktop\PowerSploit-master> Get-HttpStatus -Target www.msn.com -Path .\Recon\Dictionaries\generic.txt -Port 80 | Where-Object {$_.Status -match "ok"}

                                                                                               Status URL
                                                                                               ------ ---
                                                                                                   OK http://www.msn.com/../
                                                                                                   OK http://www.msn.com/crossdomain.xml
PS C:\Users\Administrator\Desktop\PowerSploit-master>
```

```PowerShell
PS C:\Users\Administrator\Desktop\PowerSploit-master> Get-HttpStatus -Target www.commercefun.com -Path .\Recon\Dictionaries\generic.txt -Port 80 | Where-Object {$_.Status -match "ok"}

                                                                                               Status URL
                                                                                               ------ ---
                                                                                                   OK http://www.commercefun.com/../
                                                                                                   OK http://www.commercefun.com/0/
```

```PowerShell
PS C:\Users\Administrator\Desktop\PowerSploit-master> Get-HttpStatus -Target www.google.com -Path .\Recon\Dictionaries\generic.txt -UseSSL | Where-Object {$_.Status -match "ok"}

                                                                                               Status URL
                                                                                               ------ ---
                                                                                                   OK https://www.google.com/../
                                                                                                   OK https://www.google.com/a/
PS C:\Users\Administrator\Desktop\PowerSploit-master>
```
